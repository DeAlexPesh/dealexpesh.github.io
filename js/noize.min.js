var NoizeGen = (function() {

  var div, canvas, mCanvas;
  const ACON = audioContextCheck();
  var sndNoize01, bufNoize01, sndGane01, sndNoize02, sndGane02;

  function audioContextCheck() {
    if (typeof window.AudioContext !== "undefined") {
      return new window.AudioContext();
    } else if (typeof webkitAudioContext !== "undefined") {
      return new window.webkitAudioContext();
    } else if (typeof window.mozAudioContext !== "undefined") {
      return new window.mozAudioContext();
    } else { return null; }
  };

  function NoizeGen(elId) {
    div = document.getElementById(elId);
    canvas = document.createElement('canvas');
    mCanvas = document.createElement('canvas');
    div.insertBefore(canvas, div.firstChild);
    canvas.width = window.innerWidth>>1;
    canvas.height = window.innerHeight>>1;
    canvas.style.width = '100%';
    canvas.style.height = '100%';
    canvas.style.background = '#000';
    
    var bufSize01 = 2 * ACON.sampleRate;        
    bufNoize01 = ACON.createBuffer(1, bufSize01, ACON.sampleRate);    
    var output = bufNoize01.getChannelData(0);
    for (var i = 0; i < bufSize01; i++) { output[i] = (Math.random() * 2 - 1) * 0.11; }
  };
  
  function loadSnd(sndName) {
    var request = new XMLHttpRequest();
    request.open("GET", sndName, true);
    request.responseType = "arraybuffer";
    request.onload = function() {
      ACON.decodeAudioData(request.response, function(bufNoize02) {
        sndNoize02.buffer = bufNoize02;
      });
    }
    request.send();
  }

  function makeNoizeSnd() {
    sndNoize01 = ACON.createBufferSource();
    sndNoize01.buffer = bufNoize01;
    sndNoize01.loop = true;
    sndGane01 = ACON.createGain(); 
    sndNoize01.connect(sndGane01);    
    sndGane01.connect(ACON.destination);
    
    sndNoize02 = ACON.createBufferSource();
    loadSnd("sound/Arstidir - Himinhvel.mp3");
    sndNoize02.loop = true;
    sndGane02 = ACON.createGain();
    sndNoize02.connect(sndGane02);
    sndGane02.connect(ACON.destination);
  };

  function makeNoizePic() {
    var ctx = canvas.getContext('2d', {alpha: false});
    var idata = mCanvas.getContext('2d', {alpha: false}).createImageData(canvas.width, canvas.height);
    var pix = new Uint32Array(idata.data.buffer);
    var len = pix.length - 1;
    while(len--) { pix[len] = Math.random() < 0.5 ? 0 : -1>>0; }
    ctx.putImageData(idata, 0, 0);
  };

  var loopId = null;

  NoizeGen.prototype.start = function (fps) {
    fps = typeof fps !== 'undefined' ?  fps : 30;
    if ('null' != loopId) {
      loopId = setInterval(makeNoizePic, 1000 / fps);
      if (!!ACON) {
        makeNoizeSnd();
        sndGane01.gain.value = 0.4;
        sndNoize01.start(0.1);
        sndGane02.gain.value = 0.6;
        sndNoize02.start(0.1);
      }
    }
    return this;
  };

  return NoizeGen;
})();
